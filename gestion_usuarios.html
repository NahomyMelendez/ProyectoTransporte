<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AquaLink Jim√©nez - Gesti√≥n de Usuarios</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/admin.css">
</head>

<body>

  <header>
    <div class="logo">
      <h2>AquaLink Jim√©nez</h2>
    </div>

    <nav class="menu">
      <ul>
        <li><a href="#" id="inicio">Panel Principal</a></li>
        <li><a href="#" id="gestionViajes">Gesti√≥n de Viajes</a></li>
        <li><a href="#" id="gestionUsuarios" class="active">Gesti√≥n de Usuarios</a></li>
      </ul>
    </nav>

    <div class="acciones">
      <span class="admin-badge">Administrador</span>
      <button id="logout">Cerrar sesi√≥n</button>
    </div>
  </header>


  <main>
    
    <!-- VISTA GESTI√ìN DE USUARIOS -->
    <section id="vistaUsuarios" class="vista-activa">
      <div class="seccion-header">
        <h1>Gesti√≥n de Usuarios</h1>
        <button class="btn-principal" id="btnAgregarUsuario">+ Agregar Usuario</button>
      </div>

      <div class="filtros">
        <input type="text" placeholder="Buscar usuario..." class="input-buscar" id="buscarUsuario">
        <select class="select-filtro" id="filtroRol">
          <option>Todos los roles</option>
          <option>Administradores</option>
          <option>Usuarios</option>
        </select>
        <select class="select-filtro" id="filtroEstado">
          <option>Todos los estados</option>
          <option>Activos</option>
          <option>Inactivos</option>
        </select>
      </div>

      <div class="tabla-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Tel√©fono</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaUsuarios"></tbody>
        </table>
      </div>
    </section>

  </main>


  <!-- Modal para agregar/editar usuario -->
  <div id="modalUsuario" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="tituloModal">Agregar Nuevo Usuario</h2>
      <form id="formUsuario">
        <div class="form-group">
          <label>Nombre Completo</label>
          <input type="text" id="nombre" required placeholder="Nombre completo del usuario">
        </div>
        <div class="form-group">
          <label>Correo Electr√≥nico</label>
          <input type="email" id="correo" required placeholder="correo@ejemplo.com">
        </div>
        <div class="form-group">
          <label>Tel√©fono</label>
          <input type="tel" id="telefono" required placeholder="8888-8888">
        </div>
        <div class="form-group">
          <label>Contrase√±a</label>
          <input type="password" id="password" required placeholder="M√≠nimo 6 caracteres">
        </div>
        <div class="form-group">
          <label>Rol</label>
          <select id="rol" required>
            <option value="Usuario">Usuario</option>
            <option value="Administrador">Administrador</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estado</label>
          <select id="estado" required>
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
          </select>
        </div>
        <button type="submit" class="btn-principal">Guardar Usuario</button>
      </form>
    </div>
  </div>


  <script>
    const { ipcRenderer } = require('electron');

    // Navegaci√≥n
    document.getElementById('inicio').addEventListener('click', () => {
      ipcRenderer.send('go-admin');
    });

    document.getElementById('gestionViajes').addEventListener('click', () => {
      ipcRenderer.send('abrir-gestion-viajes');
    });

    document.getElementById('gestionUsuarios').addEventListener('click', () => {
      window.location.reload();
    });

    // Cerrar sesi√≥n
    document.getElementById('logout').addEventListener('click', () => {
      ipcRenderer.send('logout');
    });

    // Modal
    const modalUsuario = document.getElementById('modalUsuario');

    document.getElementById('btnAgregarUsuario').addEventListener('click', () => {
      document.getElementById('tituloModal').textContent = 'Agregar Nuevo Usuario';
      document.getElementById('formUsuario').reset();
      modalUsuario.style.display = 'block';
    });

    // Cerrar modal
    document.querySelector('.close').addEventListener('click', () => {
      modalUsuario.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === modalUsuario) {
        modalUsuario.style.display = 'none';
      }
    });

    // --- CARGA Y GESTI√ìN DE USUARIOS DESDE JSON ---
    const fs = require('fs');
    const path = require('path');
    const usuariosPath = path.join(__dirname, 'data', 'usuarios.json');
    const tablaUsuarios = document.getElementById('tablaUsuarios');

    function cargarUsuarios() {
      let usuarios = [];
      try {
        usuarios = JSON.parse(fs.readFileSync(usuariosPath, 'utf8'));
      } catch (err) {}
      tablaUsuarios.innerHTML = '';
      usuarios.forEach(u => {
        const rolBadgeClass = u.rol === 'admin' ? 'badge-primary' : 'badge-info';
        const rolBadgeText = u.rol === 'admin' ? 'Admin' : 'Usuario';
        const estadoBadgeClass = u.estado === 'activo' ? 'badge-success' : 'badge-danger';
        tablaUsuarios.innerHTML += `
          <tr>
            <td>#${u.id.toString().padStart(3, '0')}</td>
            <td>${u.nombre}</td>
            <td>${u.correo}</td>
            <td>${u.telefono}</td>
            <td><span class="badge ${rolBadgeClass}">${rolBadgeText}</span></td>
            <td><span class="badge ${estadoBadgeClass}">${u.estado.charAt(0).toUpperCase() + u.estado.slice(1)}</span></td>
            <td>
              <button class="btn-accion btn-editar" onclick="editarUsuario(${u.id})">‚úé</button>
              <button class="btn-accion btn-eliminar" onclick="eliminarUsuario(${u.id})">üóë</button>
            </td>
          </tr>
        `;
      });
    }

    cargarUsuarios();

    document.getElementById('formUsuario').addEventListener('submit', (e) => {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const correo = document.getElementById('correo').value;
      const telefono = document.getElementById('telefono').value;
      const password = document.getElementById('password').value;
      const rol = document.getElementById('rol').value.toLowerCase();
      const estado = document.getElementById('estado').value.toLowerCase();
      let usuarios = [];
      try {
        usuarios = JSON.parse(fs.readFileSync(usuariosPath, 'utf8'));
      } catch (err) {}
      const nuevo = {
        id: usuarios.length ? usuarios[usuarios.length - 1].id + 1 : 1,
        nombre,
        correo,
        telefono,
        password,
        rol,
        estado
      };
      usuarios.push(nuevo);
      fs.writeFileSync(usuariosPath, JSON.stringify(usuarios, null, 2));
      cargarUsuarios();
      modalUsuario.style.display = 'none';
      alert('Usuario agregado exitosamente');
    });

    window.eliminarUsuario = function(id) {
      let usuarios = [];
      try {
        usuarios = JSON.parse(fs.readFileSync(usuariosPath, 'utf8'));
      } catch (err) {}
      usuarios = usuarios.filter(u => u.id !== id);
      fs.writeFileSync(usuariosPath, JSON.stringify(usuarios, null, 2));
      cargarUsuarios();
      alert('Usuario eliminado exitosamente');
    }

    // Funci√≥n para editar usuario
    function editarUsuario(id) {
      document.getElementById('tituloModal').textContent = 'Editar Usuario';
      modalUsuario.style.display = 'block';
      // Aqu√≠ podr√≠as cargar los datos del usuario para editarlos
      alert(`Editando usuario #${id}. Funci√≥n en desarrollo.`);
    }

    // Funci√≥n para eliminar usuario
    function eliminarUsuario(btn) {
      if (confirm('¬øEst√° seguro de que desea eliminar este usuario?')) {
        btn.closest('tr').remove();
        alert('Usuario eliminado exitosamente');
      }
    }

    // Filtro de b√∫squeda
    document.getElementById('buscarUsuario').addEventListener('input', function() {
      const filtro = this.value.toLowerCase();
      const filas = document.querySelectorAll('#tablaUsuarios tr');
      
      filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        fila.style.display = texto.includes(filtro) ? '' : 'none';
      });
    });

    // Filtro por rol
    document.getElementById('filtroRol').addEventListener('change', function() {
      const rolSeleccionado = this.value;
      const filas = document.querySelectorAll('#tablaUsuarios tr');
      
      filas.forEach(fila => {
        if (rolSeleccionado === 'Todos los roles') {
          fila.style.display = '';
        } else {
          const badge = fila.cells[4].querySelector('.badge');
          const rolTexto = badge.textContent === 'Admin' ? 'Administradores' : 'Usuarios';
          if (rolTexto === rolSeleccionado) {
            fila.style.display = '';
          } else {
            fila.style.display = 'none';
          }
        }
      });
    });

    // Filtro por estado
    document.getElementById('filtroEstado').addEventListener('change', function() {
      const estadoSeleccionado = this.value;
      const filas = document.querySelectorAll('#tablaUsuarios tr');
      
      filas.forEach(fila => {
        if (estadoSeleccionado === 'Todos los estados') {
          fila.style.display = '';
        } else {
          const badge = fila.cells[5].querySelector('.badge');
          if (badge && badge.textContent === estadoSeleccionado) {
            fila.style.display = '';
          } else {
            fila.style.display = 'none';
          }
        }
      });
    });
  </script>

</body>
</html>
