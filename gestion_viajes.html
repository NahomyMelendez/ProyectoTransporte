<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AquaLink Jim√©nez - Gesti√≥n de Viajes</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/admin.css">
</head>

<body>

  <header>
    <div class="logo">
      <h2>AquaLink Jim√©nez</h2>
    </div>

    <nav class="menu">
      <ul>
        <li><a href="#" id="inicio">Panel Principal</a></li>
        <li><a href="#" id="gestionViajes" class="active">Gesti√≥n de Viajes</a></li>
        <li><a href="#" id="gestionUsuarios">Gesti√≥n de Usuarios</a></li>
      </ul>
    </nav>

    <div class="acciones">
      <span class="admin-badge">Administrador</span>
      <button id="logout">Cerrar sesi√≥n</button>
    </div>
  </header>


  <main>
    
    <!-- VISTA GESTI√ìN DE VIAJES -->
    <section id="vistaViajes" class="vista-activa">
      <div class="seccion-header">
        <h1>Gesti√≥n de Viajes</h1>
        <button class="btn-principal" id="btnAgregarViaje">+ Agregar Viaje</button>
      </div>

      <div class="filtros">
        <input type="text" placeholder="Buscar viaje..." class="input-buscar" id="buscarViaje">
        <select class="select-filtro" id="filtroEstado">
          <option>Todos los estados</option>
          <option>Activos</option>
          <option>Inactivos</option>
          <option>Pendientes</option>
        </select>
        <select class="select-filtro" id="filtroRuta">
          <option>Todas las rutas</option>
          <option>Puerto Jim√©nez ‚Üí Golfito</option>
          <option>Golfito ‚Üí Puerto Jim√©nez</option>
        </select>
      </div>

      <div class="tabla-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Ruta</th>
              <th>Horario</th>
              <th>Precio</th>
              <th>Capacidad</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaViajes"></tbody>
        </table>
      </div>
    </section>

  </main>


  <!-- Modal para agregar/editar viaje -->
  <div id="modalViaje" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="tituloModal">Agregar Nuevo Viaje</h2>
      <form id="formViaje">
        <div class="form-group">
          <label>Origen</label>
          <input type="text" id="origen" required placeholder="Puerto Jim√©nez">
        </div>
        <div class="form-group">
          <label>Destino</label>
          <input type="text" id="destino" required placeholder="Golfito">
        </div>
        <div class="form-group">
          <label>Horario</label>
          <input type="time" id="horario" required>
        </div>
        <div class="form-group">
          <label>Precio (‚Ç°)</label>
          <input type="number" id="precio" required placeholder="3500">
        </div>
        <div class="form-group">
          <label>Capacidad</label>
          <input type="number" id="capacidad" required placeholder="50">
        </div>
        <div class="form-group">
          <label>Estado</label>
          <select id="estado" required>
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
            <option value="Pendiente">Pendiente</option>
          </select>
        </div>
        <button type="submit" class="btn-principal">Guardar Viaje</button>
      </form>
    </div>
  </div>


  <script>
    const { ipcRenderer } = require('electron');

    // Navegaci√≥n
    document.getElementById('inicio').addEventListener('click', () => {
      ipcRenderer.send('go-admin');
    });

    document.getElementById('gestionViajes').addEventListener('click', () => {
      window.location.reload();
    });

    document.getElementById('gestionUsuarios').addEventListener('click', () => {
      ipcRenderer.send('abrir-gestion-usuarios');
    });

    // Cerrar sesi√≥n
    document.getElementById('logout').addEventListener('click', () => {
      ipcRenderer.send('logout');
    });

    // Modal
    const modalViaje = document.getElementById('modalViaje');

    document.getElementById('btnAgregarViaje').addEventListener('click', () => {
      document.getElementById('tituloModal').textContent = 'Agregar Nuevo Viaje';
      document.getElementById('formViaje').reset();
      modalViaje.style.display = 'block';
    });

    // Cerrar modal
    document.querySelector('.close').addEventListener('click', () => {
      modalViaje.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === modalViaje) {
        modalViaje.style.display = 'none';
      }
    });

    // --- CARGA Y GESTI√ìN DE VIAJES DESDE JSON ---
    const fs = require('fs');
    const path = require('path');
    const viajesPath = path.join(__dirname, 'data', 'viajes.json');
    const tablaViajes = document.getElementById('tablaViajes');

    function cargarViajes() {
      let viajes = [];
      try {
        viajes = JSON.parse(fs.readFileSync(viajesPath, 'utf8'));
      } catch (err) {}
      tablaViajes.innerHTML = '';
      viajes.forEach(v => {
        let badgeClass = v.estado === 'activo' ? 'badge-success' : v.estado === 'pendiente' ? 'badge-warning' : 'badge-danger';
        tablaViajes.innerHTML += `
          <tr>
            <td>#${v.id.toString().padStart(3, '0')}</td>
            <td>${v.ruta}</td>
            <td>${v.horario}</td>
            <td>‚Ç°${v.precio.toLocaleString()}</td>
            <td>${v.ocupados}/${v.capacidad}</td>
            <td><span class="badge ${badgeClass}">${v.estado.charAt(0).toUpperCase() + v.estado.slice(1)}</span></td>
            <td>
              <button class="btn-accion btn-editar" onclick="editarViaje(${v.id})">‚úé</button>
              <button class="btn-accion btn-eliminar" onclick="eliminarViaje(${v.id})">üóë</button>
            </td>
          </tr>
        `;
      });
    }

    cargarViajes();

    document.getElementById('formViaje').addEventListener('submit', (e) => {
      e.preventDefault();
      const origen = document.getElementById('origen').value;
      const destino = document.getElementById('destino').value;
      const horario = document.getElementById('horario').value;
      const precio = document.getElementById('precio').value;
      const capacidad = document.getElementById('capacidad').value;
      const estado = document.getElementById('estado').value.toLowerCase();
      let viajes = [];
      try {
        viajes = JSON.parse(fs.readFileSync(viajesPath, 'utf8'));
      } catch (err) {}
      const nuevo = {
        id: viajes.length ? viajes[viajes.length - 1].id + 1 : 1,
        ruta: `${origen} ‚Üí ${destino}`,
        horario: convertirHora(horario),
        precio: Number(precio),
        capacidad: Number(capacidad),
        ocupados: 0,
        estado
      };
      viajes.push(nuevo);
      fs.writeFileSync(viajesPath, JSON.stringify(viajes, null, 2));
      cargarViajes();
      modalViaje.style.display = 'none';
      alert('Viaje agregado exitosamente');
    });

    window.eliminarViaje = function(id) {
      let viajes = [];
      try {
        viajes = JSON.parse(fs.readFileSync(viajesPath, 'utf8'));
      } catch (err) {}
      viajes = viajes.filter(v => v.id !== id);
      fs.writeFileSync(viajesPath, JSON.stringify(viajes, null, 2));
      cargarViajes();
      alert('Viaje eliminado exitosamente');
    }

    // Funci√≥n para editar viaje
    function editarViaje(id) {
      document.getElementById('tituloModal').textContent = 'Editar Viaje';
      modalViaje.style.display = 'block';
      // Aqu√≠ podr√≠as cargar los datos del viaje para editarlos
      alert(`Editando viaje #${id}. Funci√≥n en desarrollo.`);
    }

    // Funci√≥n para eliminar viaje
    function eliminarViaje(btn) {
      if (confirm('¬øEst√° seguro de que desea eliminar este viaje?')) {
        btn.closest('tr').remove();
        alert('Viaje eliminado exitosamente');
      }
    }

    // Funci√≥n para convertir hora a formato AM/PM
    function convertirHora(hora24) {
      const [horas, minutos] = hora24.split(':');
      const h = parseInt(horas);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${String(h12).padStart(2, '0')}:${minutos} ${ampm}`;
    }

    // Funci√≥n para formatear precio
    function formatearPrecio(precio) {
      return new Intl.NumberFormat('es-CR').format(precio);
    }

    // Filtro de b√∫squeda
    document.getElementById('buscarViaje').addEventListener('input', function() {
      const filtro = this.value.toLowerCase();
      const filas = document.querySelectorAll('#tablaViajes tr');
      
      filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        fila.style.display = texto.includes(filtro) ? '' : 'none';
      });
    });

    // Filtro por estado
    document.getElementById('filtroEstado').addEventListener('change', function() {
      const estadoSeleccionado = this.value;
      const filas = document.querySelectorAll('#tablaViajes tr');
      
      filas.forEach(fila => {
        if (estadoSeleccionado === 'Todos los estados') {
          fila.style.display = '';
        } else {
          const badge = fila.querySelector('.badge');
          if (badge && badge.textContent === estadoSeleccionado) {
            fila.style.display = '';
          } else {
            fila.style.display = 'none';
          }
        }
      });
    });

    // Filtro por ruta
    document.getElementById('filtroRuta').addEventListener('change', function() {
      const rutaSeleccionada = this.value;
      const filas = document.querySelectorAll('#tablaViajes tr');
      
      filas.forEach(fila => {
        if (rutaSeleccionada === 'Todas las rutas') {
          fila.style.display = '';
        } else {
          const ruta = fila.cells[1].textContent;
          if (ruta === rutaSeleccionada) {
            fila.style.display = '';
          } else {
            fila.style.display = 'none';
          }
        }
      });
    });
  </script>

</body>
</html>
